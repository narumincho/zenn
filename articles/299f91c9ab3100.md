---
title: "Rust ã® SWC ã§ TypeScript ã®ã‚³ãƒ¼ãƒ‰ã®è§£æã¨ç”Ÿæˆã‚’ã™ã‚‹"
emoji: "ğŸ‘€"
type: "tech"
topics:
  - "rust"
  - "typescript"
  - "swc"
published: true
published_at: "2023-03-08 12:55"
---

Rust ã® SWC ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ TypeScript ã®ã‚³ãƒ¼ãƒ‰ã®è§£æã¨ç”Ÿæˆã‚’ã—ã¾ã™.

https://swc.rs/

## è§£æ

```ts
/** ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ */
export type Account = {
    /** ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è­˜åˆ¥ã™ã‚‹ID */
    readonly id: string;
    /** ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå */
    readonly name: string;
}
```

ã“ã® TypeScript ã®ã‚³ãƒ¼ãƒ‰ã«å«ã¾ã‚Œã‚‹å‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’è§£æã—, æ¬¡ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã‚’å¾—ã‚‹ã“ã¨ã‚’ç›®æ¨™ã¨ã—ã¾ã™.

```
[
    TypeData {
        name: "Account",
        comment: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ",
        members: [
            MemberData {
                name: "id",
                comment: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è­˜åˆ¥ã™ã‚‹ID",
            },
            MemberData {
                name: "name",
                comment: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå",
            },
        ],
    },
]
```

æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã§å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸ.

https://github.com/narumincho/rust-swc-test/blob/6f0377ec3a098d5bfdcfe1b16ebfef465611cf42/src/main.rs#L5-L118

å‡ºåŠ›
```
[
    TypeData {
        name: "Account",
        comment: "* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ",
        members: [
            MemberData {
                name: "id",
                comment: "* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è­˜åˆ¥ã™ã‚‹ID ",
            },
            MemberData {
                name: "name",
                comment: "* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå ",
            },
        ],
    },
]
```

ã‚³ãƒ¡ãƒ³ãƒˆã« `*` ã¨æœ«å°¾ã®ç©ºç™½ãŒå…¥ã£ã¦ã‚‹å•é¡Œã¯ã‚ã‚Šã¾ã™ãŒã€ã¨ã‚Šã‚ãˆãšã§ãã¾ã—ãŸ. SWC çš„ã«ã¯ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‹ã©ã†ã‹ã¯åŒºåˆ¥ã—ãªã„ã‚ˆã†ã§ã™.

ãŠãã‚‰ãç‰¹å®šã®éƒ¨åˆ†æœ¨ã‚’æ¢ã™ã¿ãŸã„ãªæ–¹æ³•ãŒã‚ã‚Šãã†ã§ã™ãŒ, ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã‚’ã—ã¦å–ã‚Šå‡ºã—ã¾ã—ãŸ. ãã®ãŸã‚, ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã«å«ã¾ã‚Œã¦ã„ã‚‹å‹ã®å®šç¾©ã¯å–å¾—ã§ãã¾ã›ã‚“.

ã‚³ãƒ¡ãƒ³ãƒˆã®éƒ¨åˆ†ãŒ, æœ¨æ§‹é€ ã«å«ã¾ã‚Œã¦ã„ãªã„ãŸã‚åˆ¥ã§

https://github.com/narumincho/rust-swc-test/blob/6f0377ec3a098d5bfdcfe1b16ebfef465611cf42/src/main.rs#L51-L57

ã“ã®ã‚ˆã†ã«å–å¾—ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™.

ã¾ãŸ, `swc_ecma_ast::TsType::TsTypeLit` ã¨ `swc_ecma_ast::TsType::TsLitType` ã®åå‰ãŒä¼¼ã¦ã„ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™.

| swc_ecma_ast::TsType:: | TypeScript ã®ã‚³ãƒ¼ãƒ‰ |
|--|--|
|`TsTypeLit`| `{ id: string, readonly name: string }`|
|`TsLitType`| `"sample"` ã‚„ `28` |

## ç”Ÿæˆ

ä»Šåº¦ã¯é€†ã«

```rs
&TypeData {
    name: "Account".to_string(),
    comment: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ".to_string(),
    members: vec![
        MemberData {
            name: "id".to_string(),
            comment: "* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è­˜åˆ¥ã™ã‚‹ID ".to_string(),
        },
        MemberData {
            name: "name".to_string(),
            comment: "* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå ".to_string(),
        },
    ],
}
```

ã‚’å…¥åŠ›ã¨ã—ã¦, ä»¥ä¸‹ã® TypeScript ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™

```ts
/** ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ */
export type Account = {
  /** ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è­˜åˆ¥ã™ã‚‹ID */
  readonly id: string;
  /** ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå */
  readonly name: string;
};
```

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸ.

https://github.com/narumincho/rust-swc-test/blob/6f0377ec3a098d5bfdcfe1b16ebfef465611cf42/src/main.rs#L107-L231

å‡ºåŠ›

```ts
/*ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ*/ export type Account = {
    /** ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è­˜åˆ¥ã™ã‚‹ID */ readonly id: string;
    /** ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå */ readonly name: string;
};
```

ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ ã—ã¦ãã‚Œãªã„ã‚ˆã†ã§ã™.

ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚„ã¯ã‚Šswcã®æ§‹æ–‡æœ¨ã«å«ã¾ã‚Œã¦ã„ãªã„ã®ã§, åˆ¥ã§è¿½åŠ ã—ã¦ã„ã¾ã™.

`swc_common::BytePos` ãŒä½ç½®ã®æŒ‡å®š, `swc_common::Spanned::span(&BytePos)`  ã«ã‚ˆã£ã¦ã‚³ãƒ¼ãƒ‰ç¯„å›²ã® `swc_common::Span` ã«å¤‰æ›ã§ãã¾ã™. `BytePos` ã¨ã„ã†åå‰ã§ã™ãŒ, å‡ºåŠ›å…ˆã®ã‚³ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒˆä½ç½®ã«ã™ã‚‹å¿…è¦ã¯ãªã„ã¿ãŸã„ã§ã™.

- `swc_common::BytePos(0)`
- `swc_common::BytePos::DUMMY`

ã®æŒ‡å®šã‚’ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã¯å‡ºåŠ›æ™‚ã«ç„¡è¦–ã•ã‚Œã¾ã—ãŸ. 0ç•ªç›®ã¯äºˆç´„ã•ã‚Œã¦ã„ã‚‹ã¿ãŸã„ã§ã™. `Option` ã§ã¯ ã ã‚ãªç†ç”±ãŒã‚ã‚‹ã®ã ã‚ã†ã‹...

### BytePos ã®ã‚«ã‚¦ãƒ³ãƒˆæ–¹æ³•

SWC ã®ã‚³ãƒ¼ãƒ‰ ( https://rustdoc.swc.rs/src/swc_common/syntax_pos.rs.html#581 ) ã‚’è¦‹ã‚‹ã¨, GLOBALS ã¨ã„ã†ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®æ§‹é€ ä½“?ã®å€¤ã‚’1ãšã¤å¢—ã‚„ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™.

è‡ªå‰ã§è¶³ã—ã¦ã„ãã‚ˆã‚Šã‚‚ è‰¯ã„æ–¹æ³•ãŒã‚ã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¾ã™ãŒ, ã†ã¾ãã„ãã¾ã›ã‚“ã§ã—ãŸ.

```rs
swc_common::Span::dummy_with_cmt(); 
```

å®Ÿè¡Œã—ãŸçµæœã®ã‚¨ãƒ©ãƒ¼â†“

```
thread 'type_data_to_code_main' panicked at 'You should perform this operation in the closure passed to `set` of swc_common::syntax_pos::GLOBALS'
```

ã¾ãŸ, SWC ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ https://docs.rs/ ã§ã¯ãªã https://rustdoc.swc.rs/swc_common/source_map/struct.Span.html#method.dummy_with_cmt ã§å…¬é–‹ã—ã¦ã„ã‚‹. ãƒ“ãƒ«ãƒ‰ã®éƒ½åˆä¸Šãã†ãªã£ã¦ã—ã¾ã†ã®ã‹?

### è¿½è¨˜

```rs
swc_common::GLOBALS.set(&swc_common::Globals::default(), || {
  // swc_common::Span::dummy_with_cmt() ãŒä½¿ãˆã‚‹
}
 ```

ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦, `swc_common::Span::dummy_with_cmt()` ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ã¾ã—ãŸ.

https://rust-lang-jp.zulipchat.com/#narrow/stream/124300-questions/topic/SWC.20.E3.81.A7.E3.82.B3.E3.83.A1.E3.83.B3.E3.83.88.E3.81.AE.E7.94.9F.E6.88.90.E3.81.A7.E3.82.A4.E3.83.B3.E3.83.87.E3.83.83.E3.82.AF.E3.82.B9.E3.81.AE.E7.AE.A1.E7.90.86.E3.82.92.E3.81.97.E3.81.AA.E3.81.8F.E3.81.A6.E3.81.99.E3.82.80.E6.96.B9.E6.B3.95

ã‚ˆã£ã¦ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ãŸ.

https://github.com/narumincho/rust-swc-test/blob/a2ae63f42e6a00e23d9b4caf8c4bbbaa9163e6a1/src/main.rs#L107-L231

ã“ã®ä»•æ§˜ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°çš„ãªä½¿ã„æ–¹ã‚’ã—ãŸã„å ´åˆã«ä½¿ã†?ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® `scoped_tls` ã«ã‚ˆã‚‹ã‚‚ã®ã§ã—ãŸ. ã“ã® `scoped_tls` ã‚’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè‹¥å¹²åˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã« SWC ãŒæ”¹è‰¯ã—ãŸã®ãŒ `better_scoped_tls` ã¿ãŸã„ã§ã™

https://docs.rs/scoped-tls/1.0.1/scoped_tls/index.html


ãã®ä»–, ã‚ˆã‚Šè‰¯ã„æ–¹æ³•ã‚’è¦‹ã¤ã‘ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ã§ã™.