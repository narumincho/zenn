---
title: "Rust ã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ URLã®ãƒ‘ãƒ¼ã‚¹ã®ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã™ã‚‹"
emoji: "ğŸ”—"
type: "tech"
topics:
  - "rust"
  - "url"
  - "procmacro"
published: true
published_at: "2022-05-29 16:44"
---

Rust ã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ URLã®ãƒ‘ãƒ¼ã‚¹ã®ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã™ã‚‹ãƒã‚¯ãƒ­(`safe_url!`)ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ãŸ. ( https://crates.io/ ã«ã¯å…¬é–‹ã—ã¦ã„ãªã„ã®ã§, ã‚³ãƒ”ãƒšã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ä½¿ã£ã¦ãã ã•ã„. )

# æ™®é€šã®æ›¸ãæ–¹
```rust
#[test]
fn test() {
    let example_com = url::Url::parse("https//example.com").unwrap();
    println!("example_com is {:?}", &example_com);
}

```
ã“ã®æ›¸ãæ–¹ã ã¨å®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã—ã¾ã†. å®Ÿè¡Œã—ã¦ã‹ã‚‰ã™ãã«é€šã‚‹å‡¦ç†ãªã‚‰, ãƒŸã‚¹ã«ã™ãæ°—ä»˜ã‘ã‚‹ãŒ, ã‚ã£ãŸã«é€šã‚‰ãªã„å‡¦ç†ã ã¨æŒ‡å®šãƒŸã‚¹ã«æ°—ã¥ã‘ãªã„.

# ä»Šå›ä½œæˆã—ãŸ `safe_url!` ã‚’ä½¿ã†ã¨
ä¸æ­£ãªURL (`https//example.com`) ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã¨ã
![](https://storage.googleapis.com/zenn-user-upload/9a44139ce25b-20220529.png)

æ­£å¸¸ãªURL (`https://example.com`) ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã¨ã
![](https://storage.googleapis.com/zenn-user-upload/345dd89ebeea-20220529.png)

ã“ã®ã‚ˆã†ã«å®Ÿè¡Œå‰ã«ãƒŸã‚¹ã‚’æ¤œçŸ¥ã§ãã‚‹.

```toml:Cargo.toml
[package]
name = "safe-url-macro"
version = "0.1.0"
edition = "2021"

[lib]
proc-macro = true

[dependencies]
url = "2.2.2"
quote = "1.0.18"
syn = "1.0.95"

```

```rust:lib/src
#[proc_macro]
pub fn safe_url(input: proc_macro::TokenStream) -> proc_macro::TokenStream {
    match syn::parse::<syn::LitStr>(input) {
        Ok(literal) => {
            let string_literal_value = literal.value();
            match url::Url::parse(&string_literal_value) {
                Ok(_safe_url) => quote::quote! {
                    url::Url::parse(#string_literal_value).unwrap()
                }
                .into(),
                Err(error) => {
                    let message =
                        string_literal_value + " is not valid url. (" + &error.to_string() + ")";
                    quote::quote! {compile_error!(#message)}.into()
                }
            }
        }
        Err(_) => quote::quote! {compile_error!("safe_url macro support string literal")}.into(),
    }
}

```

```rust:tests/test.rs
#[test]
fn test() {
    let example_com = safe_url_macro::safe_url!("https//example.com");
    println!("example_com is {:?}", &example_com);
}

```

https://github.com/narumincho/safe-url-macro

URLã®æŒ‡å®šã¯ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚ˆã£ã¦ã¯è¡¨ç¤ºãŒå¤‰ã‚ã£ãŸã‚Šã™ã‚‹ã®ã§ãƒŸã‚¹ã«ã¯æ°—ã¥ãã‚„ã™ã„ã‘ã‚Œã©, ãƒŸã‚¹ã‚’ã™ã‚‹ã¨ããŒã‚ã‚‹ã®ã§, ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã“ã¨ã¯å¤§åˆ‡.


```rust
const EXAMPLE_COM: url::Url = safe_url_macro::safe_url!("https://example.com");
```
ã“ã®ã‚ˆã†ã« const ã§å®šæ•°ã¨ã—ã¦ã‹ã‘ã‚Œã°æ›´ã«è‰¯ã‹ã£ãŸã‘ã©,  `url::Url::parse` ãŒ `const fn`ã§ã¯ãªã‹ã£ãŸãŸã‚ ã§ããªã‹ã£ãŸ. URL ãƒ‘ãƒ¼ã‚¹ã®å‡¦ç†ã‚’ `const fn` ã§è‡ªä½œã™ã‚Œã°ã§ããã†

ã“ã†ã„ã†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«è‰²ã€…æ¤œæŸ»ã§ãã‚‹æ©Ÿèƒ½ãŒå¢—ãˆã‚‹ã¨è‰¯ã„ãªã

æ­£è¦è¡¨ç¾(Regex)ã«ã¯ã“ã® `proc-macro-regex` ãŒä½¿ãˆãã†?

https://crates.io/crates/proc-macro-regex
